<% title search_title %>
<%= javascript_include_tag "analyze_tasks" %>
<%= form_tag :action => "query_tasks" do |f| %>
    <div class="search_criteria">
      <% if params[:action] == "analyze_group_tasks" || @search_query.analyze == 'group' %>
          <div class="field">
            <%= label_tag "Group" %>
            <br/>
            <%= select_tag :search_group, options_for_select(current_user.get_groups, @search_query.groups), :multiple => true, :size => 5 %>
          </div>
          <div class="field">
            <%= label_tag "Tag" %>
            <br/>
            <%= select_tag :search_tag, options_for_select(@search_query.get_tags_for_groups, @search_query.tags), :multiple => true, :size => 5, :class => "multiselect" %>
          </div>
          <%= hidden_field_tag :analyze, "group" %>
      <% else %>
          <div class="field">
            <%= label_tag "Tag" %>
            <br/>
            <%= select_tag :search_tag, options_for_select(current_user.get_tags, @search_query.tags), :multiple => true, :size => 5, :class => "multiselect" %>
          </div>
          <%= hidden_field_tag :analyze, "task" %>
      <% end %>
      <div class="field">
        <%= label_tag "From" %>
        <br/>
        <%= text_field_tag :start_time, format_time_m_d_y(@search_query.start_time), :class => "datetime" %></div>
      <div class="field">
        <%= label_tag "To" %>
        <br/>
        <%= text_field_tag :end_time, format_time_m_d_y(@search_query.end_time), :class => "datetime" %></div>
      <br/>

      <div>
        <%= submit_tag "Search", :name => 'query', :class => 'search' %>
        <%= submit_tag "Analyze", :name => 'query', :class => 'search' %>
      </div>
    </div>
    <ul id='task_results' class='list'>
      <% @search_query.tasks.each do |task| %>
          <li class="ui-tabs-nav ui-widget-header">
            <div>
              <span><%= task.tag.name %></span>

              <div>
                <% if @search_query.search_type == "Search" && @search_query.analyze == "group" %>
                    <span>User: <span class="list_text"><%= task.user.display_name %></span></span>
                    <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <% end %>
                <span>Goal: </span><span class="list_text"><%= time_allocated(task.tag) || " unavailable" %></span>
                <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <% if @search_query.search_type == "Analyze" %>
                    <span>Time Spent: </span><span class="list_text"><%= display_time(task.performance) %></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    <span>How am I doin': </span><span id="over_the_limit>"><%= display_time_with_performance_for(task) %></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    <% earning = calculate_earning(task.tag, task.performance)
                       if !earning.nil? %>
                        <span>Earning: </span><span class="list_text"><%= earning %></span>
                    <% end %>
                <% end %>
                <% if @search_query.search_type == "Search" %>
                    <span>Time Spent: </span><span class="list_text"><%= display_time(task.time_spent) %></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    <% earning = calculate_earning(task.tag, task.time_spent)
                       if !earning.nil? %>
                        <span>Earning: </span><span class="list_text"><%= earning %></span>
                    <% end %>
                <% end %>
              </div>
            </div>
            <div><span>Start: </span><span class="list_text"><%= format_time_d_m_y(task.start_time) %></span>
              <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
              <span>End: </span><span class="list_text"><%= format_time_d_m_y(task.end_time) || "ongoing" %></span>
              <% if @search_query.search_type == "Search" %>
                  <span class="right"><%= link_to '', delete_analyze_task_path(task), confirm: 'Are you sure?', :class => 'delete_short' %></span>
              <% end %></div>
          </li>
      <% end %>
    </ul>
    <p>&nbsp;</p>
    <%= paginate @search_query.tasks %>
<% end %>